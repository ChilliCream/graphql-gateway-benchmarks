name: Benchmark

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  benchmark:
    strategy:
      fail-fast: false
      matrix:
        gateway:
          - path: apollo-federation/gateways/apollo-gateway
            name: apollo-gateway
          - path: apollo-federation/gateways/apollo-router
            name: apollo-router
          - path: apollo-federation/gateways/cosmo
            name: cosmo
          - path: apollo-federation/gateways/grafbase
            name: grafbase
          - path: apollo-federation/gateways/hive-gateway
            name: hive-gateway
          - path: apollo-federation/gateways/hive-gateway-router-runtime
            name: hive-gateway-router-runtime
          - path: apollo-federation/gateways/hive-router
            name: hive-router
          - path: composite-schema/gateways/hotchocolate
            name: hotchocolate
            display_name: "hotchocolate (.net subgraphs)"
          - path: composite-schema/gateways/hotchocolate
            name: hotchocolate-rust
            subgraphs: subgraphs-rust
        mode:
          - constant
          - ramping
    runs-on:
      group: benchmarking-2
    name: ${{ matrix.gateway.name }} (${{ matrix.mode }})
    steps:
      - uses: actions/checkout@v4

      - name: Run benchmark
        run: ./k6/benchmark.sh ${{ matrix.gateway.path }} ${{ matrix.gateway.subgraphs }} ${{ matrix.mode }}
        env:
          BENCH_DISPLAY_NAME: ${{ matrix.gateway.display_name || '' }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.gateway.name }}-${{ matrix.mode }}
          path: ${{ matrix.gateway.path }}/results/

  generate-results:
    needs: benchmark
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          pattern: results-*
          path: artifacts/

      - name: Generate result documents
        run: python3 k6/generate-results.py artifacts/ .

      - name: Write job summary
        run: |
          echo "# Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat RESULTS_CONSTANT.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat RESULTS_RAMPING.md >> $GITHUB_STEP_SUMMARY

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add RESULTS_CONSTANT.md RESULTS_RAMPING.md
          git diff --cached --quiet || git commit -m "Update benchmark results"
          git push
